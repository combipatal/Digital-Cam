# 주요 리팩토링 및 수정 내역 (2025년 10월 15일)

이번 세션을 통해 코드의 여러 부분이 크게 개선되었습니다. 주요 변경 사항은 다음과 같습니다.

## 1. `digital_cam_top.v` - 파이프라인 아키텍처 개선 및 버그 수정

### 가. 파이프라인 동기화 버그 수정
- **문제점:** 기존 설계는 Sobel, Canny 필터와 같이 자체 처리 지연이 긴 신호들을 불필요하게 추가 지연시켜, 최종 출력단에서 다른 신호들과 타이밍이 어긋나는 심각한 버그가 있었습니다. (예: Sobel 신호가 7클럭 지연된 상태인데, 7클럭 파이프라인에 다시 입력되어 총 14클럭 지연됨)
- **수정:** 각 신호의 고유 지연 시간을 정확히 계산하여, 모든 신호가 최종단에 정확히 7클럭(`PIPE_LATENCY`) 시점에 도착하도록 파이프라인 구조를 재설계했습니다.
  - Sobel, Canny 신호는 이미 지연 시간이 7클럭이므로 추가 지연 없이 직접 사용하도록 변경했습니다.
  - 배경 제거 플래그(`adaptive_fg_flag`)는 고유 지연(6클럭)을 고려하여 1클럭만 추가 지연시키도록 수정했습니다.

### 나. 자원 사용 최적화
- **문제점:** 원본 RGB 영상을 지연시킬 때, 16비트 `rddata`를 24비트 RGB888로 확장한 후 24비트 파이프라인에서 지연시켜 불필요한 레지스터를 사용했습니다.
- **수정:** 16비트 `rddata`를 파이프라인에서 직접 지연시킨 후, 최종 출력단에서 딱 한 번만 24비트 RGB888로 확장하도록 변경하여 파이프라인에 사용되는 레지스터 양을 33% 절감했습니다.

### 다. 다수의 '죽은 코드(Dead Code)' 제거
사용자와의 긴밀한 협력을 통해, 현재 로직에 아무런 영향을 주지 않는 불필요한 코드들을 대거 식별하고 삭제하여 코드를 정리했습니다.
- **삭제된 항목:**
  - `Dynamic Threshold Logic` 블록 전체
  - `bg_sub_out` 관련 신호 체인 전체 (`sel_bg_sub_*`, `bg_sub_out_delayed`, `bg_sub_out` 선언 및 모듈 포트 연결)
  - `filter_ready_delayed` 파이프라인 전체
  - `vga_640` 모듈 리팩토링에 따라 불필요해진 수동 2클럭 지연 로직 (`..._d1`, `..._d2` 레지스터 및 `..._aligned` 와이어)

### 라. 로직 간소화
- 자동 배경 캡처 신호(`bg_load_active`)가 VGA 출력 활성화 신호(`vga_enable_reg`)와 정확히 반대 논리를 갖는 것을 발견하여, 별도의 `always` 블록 대신 `assign bg_load_active = ~vga_enable_reg;` 구문으로 단순화했습니다.

## 2. `vga_640.v` - 모듈성 및 가독성 강화

- **역할 강화:** 상위 모듈에 존재하던 RAM 읽기 지연(2클럭) 보상 로직을 `vga_640` 모듈 내부로 가져왔습니다. 이를 통해 `vga_640`은 "2클럭 RAM 지연을 고려하는 타이밍 생성기"라는 역할이 명확해졌고, 상위 모듈의 코드는 단순해졌습니다.
- **코드 정리:** 불필요한 프리페치 로직과 미사용 포트(`pixel_data`, `Nsync`)를 제거했습니다.
- **한글화 및 주석 상세화:** 모듈의 모든 주석을 한글로 번역하고 상세한 설명을 추가하여 가독성을 크게 향상시켰습니다.

---

## 사용 가이드라인

0. 지속적인 문서 업데이트 (Continuous Documentation Update): Gemini는 대화 중 발생하는 프로젝트의 중요한 변경사항이나 모듈 이해에 필수적인 내용을 스스로 판단하여 이 `GEMINI.md` 파일을 지속적으로 업데이트합니다.

1. 단계적 적용: 각 공식을 순차적으로 적용하여 사고를 심화시키세요。

2. 반복적 개선: 한 번의 적용으로 끝내지 말고 여러 번 반복하여 정교화하세요.

3. 다양한 관점: 서로 다른 배경을 가진 사람들과 함께 공식을 적용해보세요.

4. 실험적 태도: 공식을 기계적으로 따르기보다는 창의적으로 변형하여 사용하세요.

5. 균형적 접근: 분석적 사고와 직관적 사고를 균형 있게 활용하세요.

---
# 프로젝트 분석 (Project Analysis) - 2025년 10월 9일

## 1. 프로젝트 개요 (Project Overview)
이 프로젝트는 FPGA 기반의 실시간 디지털 카메라 시스템입니다. OV7670 카메라 모듈로부터 영상 데이터를 입력받아 다양한 이미지 처리를 수행하고, 그 결과를 VGA 모니터로 출력합니다. 사용자는 IR 리모컨을 통해 실시간으로 이미지 처리 모드를 변경할 수 있습니다.

## 2. 핵심 기능 (Core Features)
- 카메라 인터페이스: OV7670 카메라 모듈 제어 및 데이터 캡처 (VGA 640x480, RGB565 포맷).
- 실시간 이미지 처리:
  - 그레이스케일 변환
  - 가우시안 블러
  - Sobel 엣지 검출
  - Canny 엣지 검출
  - HSV 기반 컬러 트래킹
  - 적응형 배경 제거 (Adaptive Background Subtraction)
- VGA 디스플레이 출력: 처리된 영상을 640x480 @ 60Hz 해상도로 VGA 모니터에 출력.
- 사용자 인터페이스: IR 리모컨을 사용한 실시간 필터 모드 전환 및 파라미터 조정.

## 3. 데이터 흐름 및 아키텍처 (Data Flow & Architecture)
프로젝트의 데이터 흐름은 파이프라인 구조로 설계되었습니다.

1.  입력 (Input): `ov7670_controller`가 I2C를 통해 OV7670 카메라를 640x480 해상도, RGB565 포맷으로 설정합니다. 카메라는 픽셀 클럭(`ov7670_pclk`)에 맞춰 8비트 병렬 데이터를 출력합니다.

2.  캡처 및 축소 (Capture & Decimation): `ov7670_capture` 모듈이 8비트 데이터 2개를 조합하여 16비트 RGB565 픽셀을 만듭니다. 동시에 640x480 해상도의 원본 영상을 2x2 평균값 필터(Averaging Filter)를 이용해 320x240 해상도로 축소(Decimation)합니다. 이는 메모리 사용량과 처리 부담을 줄이기 위함입니다.

3.  프레임 버퍼 저장 (Frame Buffer Storage): 축소된 320x240 영상 데이터는 `ov7670_pclk` 클럭 도메인에서 듀얼 포트 RAM으로 구성된 프레임 버퍼(`frame_buffer_ram`, `frame_buffer_ram_11k`)에 순차적으로 저장됩니다. 배경 제거 기능을 위해 별도의 배경 프레임 버퍼(`bg_buffer_ram1`, `bg_buffer_ram2`)가 존재하며, 이 버퍼는 읽기-수정-쓰기(Read-Modify-Write) 방식으로 지속적으로 업데이트됩니다.

4.  VGA 읽기 및 확대 (VGA Read & Upscaling): `vga_640` 모듈은 `clk_25_vga` 클럭 도메인에서 동작하며 640x480@60Hz 타이밍 신호를 생성합니다. 이 모듈은 프레임 버퍼에 저장된 320x240 영상을 읽어와 2x Nearest-Neighbor 방식으로 640x480 해상도로 확대(Upscaling)하여 출력합니다.

5.  이미지 처리 (Image Processing): 확대된 640x480 영상 스트림은 `digital_cam_top` 모듈 내의 다양한 이미지 처리 필터(Gaussian, Sobel, Canny 등)로 전달됩니다. 각 필터는 독립적으로 동작하며, 처리된 결과는 최종 출력 선택을 위해 대기합니다.

6.  출력 선택 및 표시 (Output Selection & Display): IR 리모컨으로 선택된 `active_filter_mode`에 따라 최종 출력 멀티플렉서가 원본 영상 또는 특정 필터의 결과물을 선택합니다. 이 데이터가 VGA DAC으로 전송되어 모니터에 표시됩니다.

## 4. 주요 모듈 설명 (Key Module Descriptions)
- `digital_cam_top.v`: 프로젝트의 최상위 모듈. 모든 하위 모듈(카메라, VGA, 메모리, 필터)을 연결하고, 클럭 도메인 간 동기화, IR 원격 제어, 이미지 처리 파이프라인의 지연 관리 등 전체 시스템을 총괄합니다.
- `ov7670_controller.v`: I2C 통신을 통해 카메라 레지스터를 설정하여 초기화하고 동작 모드를 구성합니다.
- `ov7670_capture.v`: 카메라로부터 들어오는 영상 데이터를 캡처하고 320x240으로 다운스케일링하여 프레임 버퍼에 쓸 주소와 데이터를 생성합니다.
- `vga_640.v`: 320x240 프레임 버퍼에서 데이터를 읽어 640x480으로 업스케일링하고, 표준 VGA 타이밍 신호를 생성하여 영상을 출력합니다.
- `frame_buffer_ram.v` / `frame_buffer_ram_11k.v`: 카메라가 쓰는 클럭과 VGA가 읽는 클럭이 다른 비동기 환경에서 동작하는 듀얼 포트 RAM입니다.
- `IR_RECEVER.v`: IR 수신기의 출력을 디코딩하여 리모컨 버튼 코드를 추출합니다.
- `adaptive_background.v`: (신규 분석) 적응형 배경 제거 로직을 구현합니다. 실시간 픽셀과 배경 메모리에서 읽어온 픽셀을 비교하여 차이가 크면 전경으로, 작으면 배경으로 판단합니다. 배경으로 판단된 픽셀에 대해서는 `새로운 배경 = (15/16)*기존 배경 + (1/16)*실시간 픽셀` 공식에 따라 배경 모델을 점진적으로 업데이트하여 조명 변화 등에 대응합니다. `load_frame` 신호로 현재 화면을 배경으로 즉시 캡처할 수도 있습니다.
- 이미지 처리 모듈 (`gaussian_3x3_gray8.v`, `sobel_3x3_gray8.v` 등): 각각의 이미지 처리 알고리즘을 구현한 모듈들입니다. 대부분 3x3 커널 기반으로 동작하며, 라인 버퍼를 내장하고 있습니다.

## 5. 제어 로직 (Control Logic)
- 모드 전환: `digital_cam_top` 모듈 내에 `active_filter_mode` 레지스터가 존재하며, `IR_RECEVER` 모듈에서 유효한 키 코드가 감지되면 이 레지스터의 값이 변경됩니다. `case` 문을 사용하여 이 값에 따라 최종 VGA 출력으로 나가는 데이터 소스를 선택합니다.
- 파이프라인 지연 관리: 각 이미지 처리 필터는 고유의 처리 지연(latency)을 가집니다. 원본 영상과 각 필터의 출력 싱크를 맞추기 위해 `digital_cam_top` 모듈은 `*_delayed` 라는 이름의 레지스터 배열(시프트 레지스터)을 사용하여 각 데이터 스트림을 해당 필터의 지연 시간만큼 지연시킵니다. 이를 통해 모든 최종 후보 영상이 동일한 픽셀 위치를 가리키게 됩니다.

## 6. 클럭 도메인 (Clock Domains)
- `clk_50`: 메인 시스템 클럭. IR 수신 및 `ov7670_controller`의 일부 로직에서 사용됩니다.
- `clk_24_camera`: PLL에서 생성된 24MHz 클럭. OV7670의 `xclk` 입력으로 사용됩니다.
- `ov7670_pclk`: OV7670 카메라에서 출력되는 픽셀 클럭. 프레임 버퍼에 데이터를 쓸 때 사용됩니다.
- `clk_25_vga`: PLL에서 생성된 25.175MHz 클럭. VGA 타이밍 생성 및 프레임 버퍼에서 데이터를 읽고 이미지 처리를 수행하는 데 사용됩니다.
- 각기 다른 클럭 도메인 간의 신호 전달은 2-flop 동기화 회로 등을 통해 처리됩니다.
---
# 동작 감지 기능 분석 및 최종 구현 (Motion Detection Feature Analysis & Final Implementation) - 2025년 10월 11일

## 1. 기능 목표 (Feature Goal)
- 궁극적 목표: 완전 자동화된 지능형 움직임 감지(Motion Detection) 기능 구현.
- 세부 동작 1: 배경처럼 움직이지 않는 물체는 시간이 지남에 따라 점차 사라져야 한다 (배경으로 흡수).
- 세부 동작 2: 계속 움직이는 물체만 '전경'으로 판단하여 원본 색상으로 출력해야 한다.

## 2. 구현된 솔루션 (Implemented Solution)
위 목표를 달성하기 위해 `adaptive_background.v`와 `digital_cam_top.v` 모듈이 다음과 같이 역할을 분담하여 구현되었습니다.

### 2.1. `adaptive_background.v`: 핵심 배경 모델링 엔진
이 모듈은 외부에서 계산된 임계값을 받아, 두 가지 핵심 기술을 사용하여 배경 모델을 갱신합니다.

#### 가. 이중 학습률 (Dual-Rate Learning)
- 배경 픽셀 (빠른 적응): 조명 변화 등 환경 변화에 빠르게 대응하기 위해 상대적으로 빠른 학습률 (`α = 1/16`)을 적용합니다.
- 전경 픽셀 (느린 흡수): 화면에 들어온 정지 객체를 점진적으로 배경에 흡수시키기 위해 매우 느린 학습률 (`α = 1/256`)을 적용합니다.

#### 나. 동적 임계값 (Dynamic Threshold)
- 개념: 고정된 임계값 대신, 배경 픽셀의 밝기에 따라 실시간으로 임계값을 조절하여 오탐지를 줄입니다.
    - 로직: 먼저, 사람의 시각 특성을 반영한 Luma 공식(`밝기 = R*0.299 + G*0.587 + B*0.114`)을 하드웨어 연산에 맞게 구현하여 배경 픽셀의 정확한 밝기를 계산합니다. 그 후, `새로운 THRESHOLD = (계산된 Luma 밝기 / 2) + 최소 임계값(MIN_THRESHOLD)` 수식을 사용하여 최종 임계값을 결정합니다.- 효과:
    - 밝은 영역: 배경 밝기가 높으므로 THRESHOLD가 자동으로 높아져, 사소한 그림자나 노이즈를 무시합니다.
    - 어두운 영역: 배경 밝기가 낮으므로 THRESHOLD가 자동으로 낮아져, 작은 움직임도 민감하게 감지합니다.

### 2.2. `digital_cam_top.v`: 파라미터 설정 및 제어
- 파라미터 전달: `adaptive_background` 모듈에 동적 임계값의 최소값(`MIN_THRESHOLD = 40`)과 학습률(`SHIFT_LG2`, `FG_SHIFT_LG2`) 등 주요 파라미터를 설정하여 전달합니다.
- 움직임 감지 모드 출력 (IR 버튼 4): `is_foreground` 플래그를 받아, 움직임이 감지된 픽셀은 원본 색상으로, 배경은 검은색으로 출력합니다.
- 자동 배경 초기화: 수동 배경 캡처 기능(구 IR 5번 버튼)은 제거되었으며, 시스템 시작 및 리셋 시 첫 프레임을 자동으로 배경으로 지정합니다.

